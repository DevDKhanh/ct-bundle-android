System.register("chunks:///_virtual/KKAuthBundle",["./KKAuthLayer.ts","./KKLoginPopup.ts"],(function(){return{setters:[null,null],execute:function(){}}}));

System.register("chunks:///_virtual/KKAuthLayer.ts",["cc","./LayerBase.ts","./GameData.ts","./kk.ts","./RandomTextUtil.ts","./KKHttpCenter.ts","./KKHttpRoute.ts","./KKGameUIConf.ts","./KKUtils.ts"],(function(t){var e,a,o,s,n,r,i,l,c,u,h,g;return{setters:[function(t){e=t.cclegacy,a=t._decorator},function(t){o=t.LayerBase},function(t){s=t.default},function(t){n=t.default},function(t){r=t.RandomTextUtil},function(t){i=t.httpCenter},function(t){l=t.HttpRoute},function(t){c=t.KKLayerConf,u=t.KKAuthPopupConf,h=t.KKHomePopupConf},function(t){g=t.default}],execute:function(){var d;e._RF.push({},"305catlipNAIr8q6stRvlFp","KKAuthLayer",void 0);const{ccclass:m,property:y}=a;t("KKAuthLayer",m("KKAuthLayer")(d=class extends o{constructor(...t){super(...t),this.layer=null}onLoad(){this.layer=this.getObj("layer")}async start(){await this.handleLogin()}async handleRegister(t,e){const a=await i.reqAsync(l.register,{body:{username:t,password:e},method:"POST"});return 201==a.statusCode?(this.handleLoginGame({...a.data,password:e}),!0):(console.log("Đăng ký tài khoản thất bại",a),!1)}async handleLoginRequest(t,e){const a=await i.reqAsync(l.login,{body:{username:t,password:e},method:"POST"});return 200==a.statusCode?(this.handleLoginGame({...a.data,password:e}),!0):(this.layer.active=!0,n.localMgr.removeItem("token"),n.localMgr.removeItem("username"),n.localMgr.removeItem("password"),g.showToast("Xác thực tài khoản thất bại"),!1)}async handleLoginGame(t){s.setELo(t.elo),s.setELo(t.eloBanqi,!0),s.login({id:t.id,username:t.username,token:t.jwt,gold:t.gold,goldFree:t.goldFree,password:t.password,refreshToken:t.jwtRefresh,displayName:t.displayName}),s.isLoggedIn?n.uiMgr.preLoadLayerAsync(c.Home).then((()=>{this.layer.active=!1,n.uiMgr.goLayerAsync(c.Home)})):(this.layer.active=!0,n.localMgr.removeItem("token"),n.localMgr.removeItem("username"),n.localMgr.removeItem("password"),g.showToast("Xác thực tài khoản thất bại"))}async handleLogin(){const t=n.localMgr.getItemWithDefault("username",null,!0),e=n.localMgr.getItemWithDefault("password",null,!0);t&&e?await this.handleLoginRequest(t,e):await this.autoCreateAccount()}async autoCreateAccount(){const t="ngoalong"+r.radomNumber(10),e=r.radomText(10);await this.handleRegister(t,e)}refresh(){var t;null!=(t=this.recvData)&&t.isLogout&&(s.logout(),this.layer.active=!0,g.showCommonPopup({desc:"Tài khoản của bạn đã được đăng nhập trên thiết bị khác",title:"Thông báo",btnTxt:"Đăng nhập lại",btnTxtCls:"Tạo tài khoản mới",hideCloseCorner:!0,btnCall:async()=>{const t=n.localMgr.getItemWithDefault("username",null,!0),e=n.localMgr.getItemWithDefault("password",null,!0);if(t&&e){await this.handleLoginRequest(t,e)&&n.uiMgr.goLayerAsync(c.Home)}},closeCall:async()=>{const t=r.radomText(10),e=r.radomNumber(10);await this.handleRegister(t,e)&&n.uiMgr.goLayerAsync(c.Home)}})),this.recvData.logout&&(s.logout(),this.layer.active=!0)}onBtnClick(t,e){switch(e){case"auto-login":this.autoCreateAccount();break;case"setting":n.uiMgr.showPopupAsync(h.Setting);break;case"login":n.uiMgr.showPopupAsync(u.Login)}}})||d);e._RF.pop()}}}));

System.register("chunks:///_virtual/KKLoginPopup.ts",["./rollupPluginModLoBabelHelpers.js","cc","./PopupBase.ts","./GameData.ts","./KKGameUIConf.ts","./kk.ts","./KKHttpCenter.ts","./KKHttpRoute.ts","./KKUtils.ts"],(function(e){var t,o,n,s,r,a,i,l,u,c,p,g;return{setters:[function(e){t=e.applyDecoratedDescriptor,o=e.initializerDefineProperty},function(e){n=e.cclegacy,s=e.EditBox,r=e._decorator},function(e){a=e.PopupBase},function(e){i=e.default},function(e){l=e.KKLayerConf},function(e){u=e.default},function(e){c=e.httpCenter},function(e){p=e.HttpRoute},function(e){g=e.default}],execute:function(){var d,h,m,f,w,y,I;n._RF.push({},"a58a7x1Jv9HE7uN/MmkPY5z","KKLoginPopup",void 0);const{ccclass:K,property:L}=r;e("KKLoginPopup",(d=K("KKLoginPopup"),h=L(s),m=L(s),d((y=t((w=class extends a{constructor(...e){super(...e),o(this,"usernameInput",y,this),o(this,"passwordInput",I,this)}onLoad(){this.enableClickBlankToClose();const e=u.localMgr.getItemWithDefault("username",null,!0),t=u.localMgr.getItemWithDefault("password",null,!0);(e||t)&&(this.usernameInput.string=e,this.passwordInput.string=t)}async handleLoginRequest(e,t){if(!e||!t)return g.showToast("Vui lòng nhập đầy đủ thông tin"),!1;const o=await c.reqAsync(p.login,{body:{username:e,password:t},method:"POST"});200==o.statusCode?(this.close(),this.handleLoginGame({...o.data,password:t})):(u.localMgr.removeItem("token"),u.localMgr.removeItem("username"),u.localMgr.removeItem("password"),g.showToast("Xác thực tài khoản thất bại"))}async handleLoginGame(e){i.setELo(e.elo),i.setELo(e.eloBanqi,!0),i.login({id:e.id,username:e.username,token:e.jwt,gold:e.gold,goldFree:e.goldFree,password:e.password,refreshToken:e.jwtRefresh,displayName:e.displayName}),i.isLoggedIn?u.uiMgr.preLoadLayerAsync(l.Home).then((()=>{u.uiMgr.goLayerAsync(l.Home)})):(u.localMgr.removeItem("token"),u.localMgr.removeItem("username"),u.localMgr.removeItem("password"),g.showToast("Xác thực tài khoản thất bại"))}start(){}onBtnClick(e,t){switch(t){case"login":const e=this.usernameInput.string,t=this.passwordInput.string;this.handleLoginRequest(e,t)}}}).prototype,"usernameInput",[h],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I=t(w.prototype,"passwordInput",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f=w))||f));n._RF.pop()}}}));

(function(r) {
  r('virtual:///prerequisite-imports/KKAuthBundle', 'chunks:///_virtual/KKAuthBundle'); 
})(function(mid, cid) {
    System.register(mid, [cid], function (_export, _context) {
    return {
        setters: [function(_m) {
            var _exportObj = {};

            for (var _key in _m) {
              if (_key !== "default" && _key !== "__esModule") _exportObj[_key] = _m[_key];
            }
      
            _export(_exportObj);
        }],
        execute: function () { }
    };
    });
});