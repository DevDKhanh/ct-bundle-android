System.register("chunks:///_virtual/KKBanqiBundle",["./KKBanqiLayer.ts"],(function(){return{setters:[null],execute:function(){}}}));

System.register("chunks:///_virtual/KKBanqiLayer.ts",["./rollupPluginModLoBabelHelpers.js","cc","./LayerBase.ts","./GameCoTuongData.ts","./GameData.ts","./KKGameUIConf.ts","./kk.ts","./AsyncHelper.ts","./CocosHelper.ts","./SpriteNumber.ts","./KKUtils.ts","./SocketEvent.ts","./SocketIO.ts","./GameManager.ts","./KKEndGamePopup.ts","./KKAvatarWidget.ts","./ObjectPooling.ts","./KKPieceWidget.ts"],(function(e){var t,i,o,n,a,s,r,l,c,u,h,d,p,y,f,m,g,w,b,P,v,C,E,K,D,R,T,N,A,L,I,k,B;return{setters:[function(e){t=e.applyDecoratedDescriptor,i=e.initializerDefineProperty},function(e){o=e.cclegacy,n=e.Node,a=e.Label,s=e._decorator,r=e.v3,l=e.UITransform},function(e){c=e.LayerBase},function(e){u=e.default,h=e.RoomStatus,d=e.Side},function(e){p=e.default},function(e){y=e.KKCoTuongPopupConf,f=e.KKCoTuongPanelConf,m=e.KKCoTuongWidgetlConf,g=e.KKHomePopupConf,w=e.KKLayerConf},function(e){b=e.default},function(e){P=e.default},function(e){v=e.secondsToMinute,C=e.coin},function(e){E=e.SpriteNumber},function(e){K=e.default},function(e){D=e.SocketEvent,R=e.typeSocket,T=e.actionID},function(e){N=e.default},function(e){A=e.GameManager},function(e){L=e.EFFECT},function(e){I=e.KKAvatarWidget},function(e){k=e.default},function(e){B=e.KKPieceWidget}],execute:function(){var O,M,F,G,S,z,q,V,W,H,U,j,_,$,x,J,Y,Q,X,Z,ee,te,ie,oe,ne;o._RF.push({},"c224eppq81PzJ4rojNNw4R5","KKBanqiLayer",void 0);const{ccclass:ae,property:se}=s;e("KKBanqiLayer",(O=ae("KKBanqiLayer"),M=se(n),F=se(a),G=se(a),S=se(n),z=se(n),q=se({type:[n],displayName:"Ảnh chữ sẵn sàng",tooltip:"[0] => Me; [1] => Other Player"}),V=se({type:[a],displayName:"Lable hiển thị thời gian",tooltip:"[0] => Me; [1] => Other Player"}),W=se({type:[I],displayName:"Sprite hiển thị thời gian",tooltip:"[0] => Me; [1] => Other Player"}),H=se({type:[n],displayName:"Pool chứa pieces",tooltip:"[0] => Me; [1] => Other Player"}),U=se({type:[a],displayName:"Lable hiển thị elo",tooltip:"[0] => Me; [1] => Other Player"}),j=se(E),O((x=t(($=class extends c{constructor(...e){super(...e),i(this,"otherPlayer",x,this),i(this,"otherName",J,this),i(this,"myName",Y,this),i(this,"controller",Q,this),i(this,"waiting",X,this),i(this,"spReady",Z,this),i(this,"lbTimes",ee,this),i(this,"spCountdown",te,this),i(this,"poolPieces",ie,this),i(this,"lbElo",oe,this),i(this,"time",ne,this),this.isShowEffect=!1}onLoad(){var e,t;this.time=this.getObj("controller.time",E),u.isLeaveRoom=!1,u.isViewer=null==(e=this.recvData)?void 0:e.isViewer,u.id=null==(t=this.recvData)?void 0:t.roomID}async start(){var e;u.isViewer||(N.on(D.peace,(()=>{b.uiMgr.showPopupAsync(y.CauHoa)})),N.on(D.peaceAnswer,(()=>{this.showEnd(L.hoa),this.spCountdown[0].startFill(0,!1),this.spCountdown[1].startFill(0,!1)})),N.on(D.messageCoTuong,(e=>{K.showToast(e)})),N.on(D.banqiData,(e=>{e.my&&e.other&&this.renderPieces(e)}))),N.reqAsync(D.actions,{type:R.coUp,actionID:T.joinRoom,roomID:null==(e=this.recvData)?void 0:e.roomID}),N.on(D.dataRoom,(async e=>{if(!(e.id!=u.id&&null!=u&&u.id||u.isLeaveRoom))try{var t;if(e)if(this.waiting.active=e.status==h.WAITING&&!u.isViewer,e.fen&&(u.fen=e.fen),u.isViewer)u.setData(e),this.updateInfoPlayerForViewer();else if(null!=e&&null!=(t=e.players)&&t.some((e=>(null==e?void 0:e.id)==p.info.id))?(u.setData(e),this.updateLayer()):(u.leaveRoom(),this.goBackHome(),console.log("dataRoom go back",e)),null!=e&&e.loser){const t=e.loser.id==p.info.id;if(b.uiMgr.getPopup(y.EndGame)||this.isShowEffect)return;this.isShowEffect=!0,await P.sleepAsync(.8),t?this.showEnd(L.thua):this.showEnd(L.thang),this.spCountdown[0].startFill(0,!1),this.spCountdown[1].startFill(0,!1)}}catch(e){u.leaveRoom(),this.goBackHome(),console.log("dataRoom go back",e)}})),N.on(D.countDown,(async e=>{var t;if(e.id!=u.id&&null!=u&&u.id)return;const i=null==e||null==(t=e.players)?void 0:t.find((e=>e.isReady&&e.id==p.info.id));this.time&&(this.time.value=e.countdown),u.isViewer||(e.status!=h.COUNTDOWN?this.controller.active=!1:this.controller.active=!i),e.status==h.PLAYING?this.updatePlaying(e):e.status!=h.COUNTDOWN&&e.status!=h.WAITING||(this.waiting.active=e.status==h.WAITING)}));const t=this.getObj("ban"),i=await b.uiMgr.createPanelAsync(f.BanCo,{isBanqi:!0});t.addChild(i),this.getObj("menu.xin-hoa-button").active=!u.isViewer,this.getObj("menu.btn-doi").active=u.isViewer}onDestroy(){N.off(D.dataRoom),N.off(D.peace),N.off(D.peaceAnswer),N.off(D.countDown),N.off(D.messageCoTuong),N.off(D.banqiData)}showEnd(e){var t,i,o;b.uiMgr.showPopupAsync(y.EndGame,{effect:e,name:(null==(t=u.cloneOtherPlayer)?void 0:t.displayname)??(null==(i=u.cloneOtherPlayer)?void 0:i.username),elo:null==(o=u.cloneOtherPlayer)?void 0:o.elo})}renderPieces({my:e,other:t}){this.poolPieces[0]&&this.poolPieces[1]?(this.poolPieces[0].children.forEach((e=>{k.putNode(e)})),this.poolPieces[1].children.forEach((e=>{k.putNode(e)})),e.forEach((async(e,t)=>{await this.createPiece(e,this.poolPieces[0],-t)})),t.forEach((async(e,t)=>{await this.createPiece(e,this.poolPieces[1],t)}))):console.error("poolPieces is not properly initialized:",this.poolPieces)}async createPiece(e,t,i){try{if(!t)return void console.error("Container is null or undefined. Cannot create piece.");const i=await k.getNode(m.KKPieceWidget);i.setParent(t),i.scale=r(.8,.8,0),i.getComponent(l).height=80,i.getComponent(l).width=80,i.name=`${e.type}_${e.color}`;const o="r"==e.color?d.RED:d.BLACK,n=i.getComponent(B);console.log(`Side: ${d[o]}, ${e.realType??e.type}`),n.show(e.realType??e.type,o,e)}catch(e){console.error("Error creating piece:",e)}}updatePlaying(e){if(u.isViewer){const t=null==e?void 0:e.playerTime[u.side],i=null==e?void 0:e.playerTime[u.side==d.RED?d.BLACK:d.RED];this.lbTimes[0].string=v(t||0),this.lbTimes[1].string=v(i||0),A.instance.startGame(u.side,!0),this.spCountdown[0].startFill(e.countdown,u.side==e.currentTurn),this.spCountdown[1].startFill(e.countdown,u.side!=e.currentTurn),this.isShowEffect=!1}else{var t;const i=e.players.find((e=>e.id==p.info.id)),o=null==e?void 0:e.playerTime[i.side],n=null==e?void 0:e.playerTime[i.side==d.RED?d.BLACK:d.RED];this.lbTimes[0].string=v(o||0),this.lbTimes[1].string=v(n||0),u.side=i.side,null==A||null==(t=A.instance)||t.startGame(i.side),this.spCountdown[0].startFill(e.countdown,i.side==e.currentTurn),this.spCountdown[1].startFill(e.countdown,i.side!=e.currentTurn),this.isShowEffect=!1}}updateLayer(){var e,t,i,o;u.otherPlayer?(this.otherPlayer.active=!0,this.otherName.string=u.otherPlayer.displayname??u.otherPlayer.username,this.lbElo[1].string=C(null==(t=u.otherPlayer)?void 0:t.elo),null==(i=this.spCountdown[1])||i.init(null==(o=u.otherPlayer)?void 0:o.elo)):this.otherPlayer.active=!1;this.myName.string=p.info.displayname??p.info.username,this.lbElo[0].string=C(p.getElo(!0)),null==(e=this.spCountdown[0])||e.init(p.getElo(!0)),this.checkReady()}checkReady(){u.players.forEach((e=>{e.id==p.info.id?this.spReady[0].active=e.isReady:this.spReady[1].active=e.isReady}))}updateInfoPlayerForViewer(){const e=u.players.find((e=>e.side==u.side)),t=u.players.find((e=>e.side!=u.side));var i,o;e&&(this.myName.string=e.displayname??e.username,this.lbElo[0].string=C(e.elo),null==(i=this.spCountdown[0])||i.init(e.elo));t?(this.otherPlayer.active=!0,this.otherName.string=t.displayname??t.username,this.lbElo[1].string=C(t.elo),null==(o=this.spCountdown[1])||o.init(t.elo)):this.otherPlayer.active=!1;this.spReady.forEach((e=>{e.active=!1}))}onBtnClick(e,t){var i;switch(t){case"menu":b.uiMgr.showPopupAsync(y.Menu);break;case"cauhoa":N.reqAsync(D.actions,{type:R.coUp,actionID:T.peace});break;case"ready":this.controller.active=!1,N.reqAsync(D.actions,{type:R.coUp,actionID:T.readyRoom}),null==A||null==(i=A.instance)||i.resetBoard();break;case"help":b.uiMgr.showPopupAsync(g.Help);break;case"change":if(!u.fen)return void console.warn("FEN chưa sẵn sàng, bỏ qua startGame.",u.fen);u.side=u.side==d.RED?d.BLACK:d.RED,A.instance.resetBoard(),A.instance.startGame(u.side),this.updateInfoPlayerForViewer()}}goBackHome(){N.reqAsync(D.actions,{type:R.coUp,actionID:T.leaveRoom}),b.uiMgr.goLayerAsync(w.Home)}}).prototype,"otherPlayer",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),J=t($.prototype,"otherName",[F],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Y=t($.prototype,"myName",[G],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Q=t($.prototype,"controller",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),X=t($.prototype,"waiting",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Z=t($.prototype,"spReady",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ee=t($.prototype,"lbTimes",[V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),te=t($.prototype,"spCountdown",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ie=t($.prototype,"poolPieces",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oe=t($.prototype,"lbElo",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ne=t($.prototype,"time",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_=$))||_));o._RF.pop()}}}));

(function(r) {
  r('virtual:///prerequisite-imports/KKBanqiBundle', 'chunks:///_virtual/KKBanqiBundle'); 
})(function(mid, cid) {
    System.register(mid, [cid], function (_export, _context) {
    return {
        setters: [function(_m) {
            var _exportObj = {};

            for (var _key in _m) {
              if (_key !== "default" && _key !== "__esModule") _exportObj[_key] = _m[_key];
            }
      
            _export(_exportObj);
        }],
        execute: function () { }
    };
    });
});